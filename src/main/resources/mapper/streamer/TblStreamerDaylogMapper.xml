<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ittime.linglingbo.modules.streamer.mapper.TblStreamerDaylogMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.ittime.linglingbo.modules.streamer.model.TblStreamerDaylog">
        <id column="id" property="id" />
        <result column="create_time" property="createTime" />
        <result column="modified_time" property="modifiedTime" />
        <result column="deleted" property="deleted" />
        <result column="log_date" property="logDate" />
        <result column="streamer_id" property="streamerId" />
        <result column="day_fans" property="dayFans" />
        <result column="day_videos" property="dayVideos" />
        <result column="day_likes" property="dayLikes" />
        <result column="day_comments" property="dayComments" />
        <result column="day_shares" property="dayShares" />
    </resultMap>
    <select id="fansRiseRank" resultType="com.ittime.linglingbo.modules.ums.dto.UmsFansRiseRankVO">
        SELECT
            a.*,
            @rank := @rank + 1 fans_rank
        FROM
            (
            SELECT
                tbl_streamer_daylog.streamer_id,
                SUM( day_fans ) fans_rise,
                MAX( image_url ),
                streamer_name,
                total_fans,
                fans_rank_rise
            FROM
                `tbl_streamer_daylog`
                LEFT JOIN ums_admin_streamer ON ums_admin_streamer.id = tbl_streamer_daylog.streamer_id
                LEFT JOIN tbl_image ON tbl_image.image_id = ums_admin_streamer.image_id
                LEFT JOIN tbl_streamer_append ON tbl_streamer_append.streamer_id = tbl_streamer_daylog.streamer_id
            where
            <if test="fromDay != null and fromDay != ''">
                log_date >=  #{fromDay}
            </if>
            <if test="endDay != null and endDay != ''">
                and log_date <![CDATA[ <= ]]> #{endDay}
            </if>
            <if test="keyWord != null and keyWord !=''">
                and streamer_name like concat( concat( "%", #{keyWord} ), "%" )
            </if>
            <if test="industry != null and industry != ''">
                and tbl_streamer_append.industry = #{industry}
            </if>
            GROUP BY
                tbl_streamer_daylog.streamer_id
            ) a,( SELECT @rank := 0 ) rank
            ORDER BY
            a.fans_rise DESC
        <if test="pageSize != null and offset != null">
            limit #{offset}, #{pageSize}
        </if>
    </select>

    <select id="totalCount" resultType="java.lang.Long">
        select
            count(*)
        from (SELECT
        1
        FROM
        `tbl_streamer_daylog`
        LEFT JOIN ums_admin_streamer ON ums_admin_streamer.id = tbl_streamer_daylog.streamer_id
        LEFT JOIN tbl_image ON tbl_image.image_id = ums_admin_streamer.image_id
        LEFT JOIN tbl_streamer_append ON tbl_streamer_append.streamer_id = tbl_streamer_daylog.streamer_id
        where
        <if test="fromDay != null and fromDay != ''">
            log_date >=  #{fromDay}
        </if>
        <if test="endDay != null and endDay != ''">
            and log_date <![CDATA[ <= ]]> #{endDay}
        </if>
        <if test="keyWord != null and keyWord !=''">
            and streamer_name like concat( concat( "%", #{keyWord} ), "%" )
        </if>
        <if test="industry != null and industry != ''">
            and tbl_streamer_append.industry = #{industry}
        </if>
        GROUP BY
        tbl_streamer_daylog.streamer_id) a
    </select>
</mapper>
